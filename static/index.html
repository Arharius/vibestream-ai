<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>VibeStream PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid #ec4899; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-black italic bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 mb-4">VIBESTREAM PRO</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="glass p-6 rounded-3xl">
                <input id="url" type="text" placeholder="YouTube URL..." class="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 mb-4 outline-none focus:border-pink-500">
                <button onclick="run('url')" class="w-full bg-pink-600 hover:bg-pink-700 font-bold py-4 rounded-xl transition-all">–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨</button>
            </div>
            <div class="glass p-6 rounded-3xl">
                <input id="file" type="file" class="w-full mb-4 text-sm text-slate-400">
                <button onclick="run('file')" class="w-full bg-emerald-600 hover:bg-emerald-700 font-bold py-4 rounded-xl transition-all">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–ê–ô–õ</button>
            </div>
        </div>

        <div id="status-box" class="hidden mb-8 p-6 glass border-l-4 border-pink-500 rounded-xl flex items-center gap-4">
            <div class="spinner"></div>
            <div id="status-text" class="font-bold text-pink-100">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <div id="result" class="hidden glass p-8 rounded-3xl prose prose-invert max-w-none border border-slate-800"></div>
    </div>

    <script>
        let timer;

        async function run(type) {
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');
            const resultBox = document.getElementById('result');
            
            resultBox.classList.add('hidden');
            statusBox.classList.remove('hidden');
            statusText.innerText = "üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...";

            try {
                let r;
                if(type === 'url') {
                    const url = document.getElementById('url').value;
                    if(!url) return alert("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É!");
                    r = await fetch(`/process-live?url=${encodeURIComponent(url)}`);
                } else {
                    const file = document.getElementById('file').files[0];
                    if(!file) return alert("–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª!");
                    const fd = new FormData(); fd.append('file', file);
                    r = await fetch('/upload-audio', { method: 'POST', body: fd });
                }

                const data = await r.json();
                console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ F12

                if(data && data.task_id) {
                    pollStatus(data.task_id);
                } else {
                    statusText.innerText = "‚ùå –û—à–∏–±–∫–∞: " + (data.message || "–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª ID –∑–∞–¥–∞—á–∏");
                }
            } catch (e) {
                statusText.innerText = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message;
            }
        }

        function pollStatus(id) {
            const statusText = document.getElementById('status-text');
            const resultBox = document.getElementById('result');
            const statusBox = document.getElementById('status-box');

            if(timer) clearInterval(timer);

            timer = setInterval(async () => {
                try {
                    const r = await fetch(`/check-status?task_id=${id}`);
                    const json = await r.json();
                    
                    // –ì–õ–ê–í–ù–´–ô –§–ò–ö–° –û–®–ò–ë–ö–ò UNDEFINED
                    const responseData = json.data;

                    if (responseData && typeof responseData === 'object' && responseData.result) {
                        // –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º result ‚Äî –º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏!
                        clearInterval(timer);
                        resultBox.innerHTML = marked.parse(responseData.result);
                        resultBox.classList.remove('hidden');
                        statusBox.classList.add('hidden');
                    } else if (responseData) {
                        // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë –∫–∞–∫ —Å—Ç–∞—Ç—É—Å
                        statusText.innerText = responseData;
                    }
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞:", e);
                }
            }, 3000);
        }
    </script>
</body>
</html>