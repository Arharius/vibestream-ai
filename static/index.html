<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeStream AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .gradient-text {
            background: linear-gradient(to right, #c084fc, #db2777);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .history-item { 
            cursor: pointer; 
            transition: all 0.2s; 
            border-left: 3px solid transparent;
        }
        .history-item:hover { 
            background-color: rgba(255,255,255,0.05); 
            border-left-color: #db2777; 
        }

        .prose h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem; color: #fff; }
        .prose h2 { font-size: 1.4rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.8rem; color: #f8fafc; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; color: #cbd5e1; }
        
        .loader { display: none; border: 3px solid #1e293b; border-top: 3px solid #db2777; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-72 bg-[#020617] border-r border-gray-800 flex flex-col z-20">
        <div class="p-6">
            <h1 class="text-2xl font-bold tracking-tight">Vibe<span class="gradient-text">Stream</span></h1>
            <p class="text-xs text-gray-500 mt-1 uppercase tracking-widest">History Manager</p>
        </div>

        <div class="px-4 pb-2 flex justify-between items-center">
            <span class="text-[10px] text-gray-500 font-bold uppercase">–ò—Å—Ç–æ—Ä–∏—è</span>
            <button onclick="clearHistory()" class="text-[10px] text-red-500 hover:text-red-400 uppercase font-bold">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div id="historyList" class="flex-1 overflow-y-auto px-2 py-2 space-y-1">
            </div>

        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center gap-2 text-xs text-gray-500">
                <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]"></div>
                SYSTEM READY
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <div class="bg-[#0f172a]/80 backdrop-blur-md border-b border-gray-800 p-6 z-10 sticky top-0">
            <div class="max-w-3xl mx-auto w-full">
                <div class="flex bg-[#1e293b] rounded-lg p-1 mb-4 w-fit">
                    <button id="tabLink" onclick="switchMode('link')" class="px-4 py-1.5 text-sm rounded-md transition-all bg-gray-700 text-white shadow-sm">üîó –°—Å—ã–ª–∫–∞</button>
                    <button id="tabFile" onclick="switchMode('file')" class="px-4 py-1.5 text-sm rounded-md transition-all text-gray-400">üìÅ –§–∞–π–ª</button>
                </div>

                <div class="flex gap-3">
                    <div id="linkMode" class="flex-1">
                        <input type="text" id="youtubeUrl" class="w-full bg-[#1e293b] border border-gray-700 text-white text-sm rounded-xl focus:ring-2 focus:ring-[#db2777] block p-3 pl-4 transition-all" placeholder="–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ...">
                    </div>
                    <div id="fileMode" class="flex-1 hidden">
                        <label class="flex items-center justify-center w-full h-[46px] rounded-xl cursor-pointer bg-[#1e293b] border border-gray-700 hover:border-[#db2777]">
                            <span id="fileName" class="text-sm text-gray-400 truncate px-4">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª...</span>
                            <input type="file" id="fileInput" class="hidden" accept="audio/*,video/*">
                        </label>
                    </div>
                    <button id="generateBtn" class="bg-gradient-to-r from-[#c084fc] to-[#db2777] text-white font-medium rounded-xl text-sm px-8 py-3 flex items-center gap-2 hover:opacity-90 transition-all disabled:opacity-50">
                        <span id="btnText">–ó–∞–ø—É—Å—Ç–∏—Ç—å</span>
                        <div class="loader"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div class="max-w-3xl mx-auto">
                <div id="emptyState" class="flex flex-col items-center justify-center h-[50vh] text-gray-500">
                    <div class="text-4xl mb-4 opacity-20">üì°</div>
                    <p class="opacity-50">–ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ</p>
                </div>
                <div id="resultContent" class="hidden prose prose-invert max-w-none pb-24"></div>
            </div>
        </div>
    </main>

    <script>
        let currentMode = 'link';

        // --- üíæ –õ–û–ì–ò–ö–ê –ò–°–¢–û–†–ò–ò ---
        function saveToHistory(content) {
            try {
                const history = JSON.parse(localStorage.getItem('vibeHistory') || '[]');
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
                const lines = content.split('\n').filter(l => l.trim() !== '');
                let rawTitle = lines[0] || "–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç";
                // –ß–∏—Å—Ç–∏–º –æ—Ç Markdown —Å–∏–º–≤–æ–ª–æ–≤
                let cleanTitle = rawTitle.replace(/[#*]/g, '').trim();
                
                if (cleanTitle.length > 40) cleanTitle = cleanTitle.substring(0, 40) + "...";

                const date = new Date().toLocaleString('ru-RU', { 
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
                });

                const historyItem = { 
                    id: Date.now(), 
                    title: cleanTitle, 
                    date: date, 
                    content: content 
                };

                history.unshift(historyItem);
                localStorage.setItem('vibeHistory', JSON.stringify(history.slice(0, 20)));
                
                renderHistory();
            } catch (e) {
                console.error("Save error:", e);
            }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('vibeHistory') || '[]');
            
            if (history.length === 0) {
                list.innerHTML = '<div class="text-[11px] text-gray-600 text-center mt-10 italic">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç</div>';
                return;
            }

            list.innerHTML = history.map(item => `
                <div onclick="loadFromHistory(${item.id})" class="history-item p-3 rounded-lg mb-1 group border-b border-gray-800/30">
                    <div class="text-sm font-medium text-gray-300 truncate group-hover:text-white">
                        ${item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                    </div>
                    <div class="text-[10px] text-gray-600 mt-1">${item.date}</div>
                </div>
            `).join('');
        }

        function loadFromHistory(id) {
            try {
                const history = JSON.parse(localStorage.getItem('vibeHistory') || '[]');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å—Ç—Ä–æ–≥–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Å–ª—É—á–∞–π —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
                const item = history.find(i => i.id == id);
                if (item) {
                    document.getElementById('emptyState').classList.add('hidden');
                    const contentDiv = document.getElementById('resultContent');
                    contentDiv.classList.remove('hidden');
                    contentDiv.innerHTML = marked.parse(item.content);
                    // –°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö
                    document.querySelector('main .overflow-y-auto').scrollTop = 0;
                }
            } catch (e) {
                console.error("Load error:", e);
            }
        }

        function clearHistory() {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')) {
                localStorage.removeItem('vibeHistory');
                renderHistory();
                location.reload();
            }
        }

        // --- –ò–ù–¢–ï–†–§–ï–ô–° ---
        function switchMode(mode) {
            currentMode = mode;
            const tabLink = document.getElementById('tabLink');
            const tabFile = document.getElementById('tabFile');
            
            if(mode === 'link') {
                tabLink.className = 'px-4 py-1.5 text-sm rounded-md transition-all bg-gray-700 text-white shadow-sm';
                tabFile.className = 'px-4 py-1.5 text-sm rounded-md transition-all text-gray-400';
                document.getElementById('linkMode').classList.remove('hidden');
                document.getElementById('fileMode').classList.add('hidden');
            } else {
                tabFile.className = 'px-4 py-1.5 text-sm rounded-md transition-all bg-gray-700 text-white shadow-sm';
                tabLink.className = 'px-4 py-1.5 text-sm rounded-md transition-all text-gray-400';
                document.getElementById('linkMode').classList.add('hidden');
                document.getElementById('fileMode').classList.remove('hidden');
            }
        }

        document.getElementById('fileInput').addEventListener('change', function() {
            if (this.files[0]) document.getElementById('fileName').innerText = this.files[0].name;
        });

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const btn = document.getElementById('generateBtn');
            const loader = document.querySelector('.loader');
            const content = document.getElementById('resultContent');
            const empty = document.getElementById('emptyState');
            
            btn.disabled = true;
            document.getElementById('btnText').textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            loader.style.display = 'block';
            
            try {
                let response;
                if (currentMode === 'link') {
                    const url = document.getElementById('youtubeUrl').value;
                    if(!url) throw new Error("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É!");
                    response = await fetch(`/process-live?url=${encodeURIComponent(url)}`);
                } else {
                    const files = document.getElementById('fileInput').files;
                    if(!files.length) throw new Error("–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª!");
                    const fd = new FormData();
                    fd.append("file", files[0]);
                    response = await fetch(`/process-upload`, { method: "POST", body: fd });
                }

                const data = await response.json();
                if(data.status === 'success') {
                    empty.classList.add('hidden');
                    content.classList.remove('hidden');
                    content.innerHTML = marked.parse(data.content);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                    saveToHistory(data.content);
                    
                    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
                    document.getElementById('youtubeUrl').value = '';
                    document.getElementById('fileInput').value = '';
                    document.getElementById('fileName').innerText = '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª...';
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                document.getElementById('btnText').textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
                loader.style.display = 'none';
            }
        });

        // –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        window.onload = renderHistory;
    </script>
</body>
</html>