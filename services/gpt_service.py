import os
import google.generativeai as genai
from dotenv import load_dotenv

load_dotenv()

api_key = os.getenv("GOOGLE_API_KEY")
if api_key:
    genai.configure(api_key=api_key)

def analyze_content(text: str):
    print("üß† [AI] –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç...")

    if not api_key:
        return "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç GOOGLE_API_KEY."

    # –¢–≤–æ–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π (–æ—Ç —Å–∞–º—ã—Ö –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
    priority_models = [
        'gemini-2.5-flash',       # –°–∞–º–∞—è —Å–≤–µ–∂–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è
        'gemini-2.0-flash',       # –°—Ç–∞–±–∏–ª—å–Ω–∞—è 2.0
        'gemini-flash-latest',    # –í—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è
        'gemini-1.5-flash',       # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    ]
    
    selected_model = None

    # 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¢–ï–ë–ï
    try:
        my_models = [m.name.replace('models/', '') for m in genai.list_models()]
        
        # 2. –ò—â–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        for target in priority_models:
            if target in my_models:
                selected_model = target
                break
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–≤–ø–∞–ª–æ, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –ø–æ–ø–∞–≤—à—É—é—Å—è "gemini"
        if not selected_model:
            selected_model = "gemini-2.0-flash" # –§–æ—Ä—Å–∏—Ä—É–µ–º 2.0, –æ–Ω–∞ —É —Ç–µ–±—è —Ç–æ—á–Ω–æ –µ—Å—Ç—å

    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏: {e}. –ü—Ä–æ–±—É—é –¥–µ—Ñ–æ–ª—Ç–Ω—É—é.")
        selected_model = "gemini-2.0-flash"

    print(f"ü§ñ –ò—Å–ø–æ–ª—å–∑—É—é –º–æ—â—å –º–æ–¥–µ–ª–∏: {selected_model}")

    system_prompt = """
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä VibeStream. 
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –∏–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≤–∏–¥–µ–æ –≤–∏—Ä—É—Å–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è –±–ª–æ–≥–∞.
    
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–π Markdown):
    
    # üìù [–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–ª–∏–∫–±–µ–π—Ç–Ω—ã–π, –Ω–æ —á–µ—Å—Ç–Ω—ã–π]
    
    ## ‚ö°Ô∏è TL;DR (–°—É—Ç—å –≤ –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏)
    
    ## üî• –ì–ª–∞–≤–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã
    * (3-5 –∫–ª—é—á–µ–≤—ã—Ö –º—ã—Å–ª–µ–π –∏–∑ –≤–∏–¥–µ–æ)
    
    ## üöÄ –ü–æ—Å—Ç –¥–ª—è Telegram
    (–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞, —Å —ç–º–æ–¥–∑–∏, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –Ω–∞ –∞–±–∑–∞—Ü—ã. –¢–æ–Ω: –¥—Ä—É–∂–µ—Å–∫–∏–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π)
    
    ## üè∑ –•–µ—à—Ç–µ–≥–∏
    #(—Ç–µ–≥1) #(—Ç–µ–≥2) #(—Ç–µ–≥3)
    """

    try:
        model = genai.GenerativeModel(selected_model)
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å —Ç–æ–∫–µ–Ω–∞–º–∏, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –æ–≥—Ä–æ–º–Ω–æ–µ
        response = model.generate_content(system_prompt + "\n\n–¢–µ–∫—Å—Ç –≤–∏–¥–µ–æ:\n" + text[:40000])
        return response.text
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ Gemini: {e}")
        return f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}"